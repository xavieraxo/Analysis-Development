@page "/login"
@inject IAuthService AuthService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject AuthenticationStateProvider AuthenticationStateProvider

<MudContainer MaxWidth="MaxWidth.Small" Class="mt-16">
    <MudPaper Elevation="3" Class="pa-8">
        <MudText Typo="Typo.h4" Align="Align.Center" GutterBottom="true">Iniciar Sesión</MudText>
        
        <EditForm Model="@_loginModel" OnSubmit="HandleLogin">
            
            <!-- Campo de Email - Oculto si se muestra el hash de SuperAdmin -->
            @if (!_showSuperAdminHash)
            {
                <MudTextField @bind-Value="_loginModel.Email" 
                             @bind-Value:after="OnEmailChanged"
                             Label="Email" 
                             Variant="Variant.Outlined" 
                             FullWidth="true" 
                             Class="mt-4"
                             Required="true" />
            }
            
            <!-- Campo de Hash de SuperAdministrador - Oculto por defecto -->
            @if (_showSuperAdminHash)
            {
                <MudTextField @bind-Value="_superAdminHash" 
                             Label="Hash de SuperAdministrador" 
                             Variant="Variant.Outlined" 
                             FullWidth="true" 
                             Class="mt-4"
                             Required="true"
                             HelperText="Ingrese el hash de acceso de SuperAdministrador" />
            }
            
            <!-- Campo de Contraseña - Oculto si se muestra el hash de SuperAdmin -->
            @if (!_showSuperAdminHash)
            {
                <MudTextField @bind-Value="_loginModel.Password" 
                             Label="Contraseña" 
                             Variant="Variant.Outlined" 
                             InputType="InputType.Password" 
                             FullWidth="true" 
                             Class="mt-4" />
            }
            
            <!-- Enlace para mostrar/ocultar modo SuperAdministrador -->
            <div class="mt-3" style="text-align: right;">
                <MudLink OnClick="ToggleSuperAdminMode" Style="cursor: pointer; font-size: 0.875rem;">
                    @if (_showSuperAdminHash)
                    {
                        <text>← Volver a login normal</text>
                    }
                    else
                    {
                        <text>¿Eres SuperAdministrador?</text>
                    }
                </MudLink>
            </div>
            
            <MudButton ButtonType="ButtonType.Submit" 
                      Variant="Variant.Filled" 
                      Color="Color.Primary" 
                      FullWidth="true" 
                      Class="mt-4"
                      Disabled="@_isLoading">
                @if (_isLoading)
                {
                    <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                    <MudText Class="ms-2">Iniciando sesión...</MudText>
                }
                else
                {
                    <MudText>Iniciar Sesión</MudText>
                }
            </MudButton>
        </EditForm>
        
        <MudDivider Class="my-4" />
        
        <MudText Align="Align.Center">
            <MudLink Href="/register">¿No tienes cuenta? Regístrate</MudLink>
        </MudText>
    </MudPaper>
</MudContainer>

@code {
    private LoginRequest _loginModel = new();
    private bool _isLoading = false;
    private bool _showSuperAdminHash = false;
    private string _superAdminHash = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        // Si el usuario ya está autenticado, redirigir a Home
        if (await AuthService.IsAuthenticatedAsync())
        {
            Navigation.NavigateTo("/Home");
        }
    }

    private void ToggleSuperAdminMode()
    {
        _showSuperAdminHash = !_showSuperAdminHash;
        
        // Limpiar campos al cambiar de modo
        if (_showSuperAdminHash)
        {
            // Al mostrar el hash, limpiar email y contraseña
            _loginModel.Email = string.Empty;
            _loginModel.Password = string.Empty;
        }
        else
        {
            // Al volver a modo normal, limpiar el hash
            _superAdminHash = string.Empty;
        }
        
        StateHasChanged();
    }

    private void OnEmailChanged()
    {
        // Si no es un email válido (probablemente es un hash), limpiar el campo de contraseña
        if (!IsValidEmail(_loginModel.Email))
        {
            _loginModel.Password = string.Empty;
            StateHasChanged();
        }
    }

    private static bool IsValidEmail(string email)
    {
        if (string.IsNullOrWhiteSpace(email))
            return true; // Si está vacío, requerir contraseña por defecto

        try
        {
            var addr = new System.Net.Mail.MailAddress(email);
            return addr.Address == email;
        }
        catch
        {
            // Si no es un email válido, probablemente es un hash
            return false;
        }
    }

    private async Task HandleLogin(EditContext context)
    {
        string email;
        string password;

        // Validación según el modo (SuperAdmin o normal)
        if (_showSuperAdminHash)
        {
            // Modo SuperAdministrador: solo validar hash
            if (string.IsNullOrWhiteSpace(_superAdminHash))
            {
                Snackbar.Add("El hash de SuperAdministrador es requerido", Severity.Warning);
                return;
            }

            email = _superAdminHash.Trim();
            password = string.Empty; // No se requiere contraseña para login con hash
        }
        else
        {
            // Modo normal: validar email y contraseña
            if (string.IsNullOrWhiteSpace(_loginModel.Email))
            {
                Snackbar.Add("El email es requerido", Severity.Warning);
                return;
            }

            var isValidEmail = IsValidEmail(_loginModel.Email);
            
            if (!isValidEmail)
            {
                Snackbar.Add("Por favor, ingrese un email válido", Severity.Warning);
                return;
            }

            if (string.IsNullOrWhiteSpace(_loginModel.Password))
            {
                Snackbar.Add("La contraseña es requerida", Severity.Warning);
                return;
            }

            email = _loginModel.Email.Trim();
            password = _loginModel.Password;
        }

        _isLoading = true;
        try
        {
            var response = await AuthService.LoginAsync(email, password);
            
            if (response != null && !string.IsNullOrEmpty(response.Token))
            {
                Snackbar.Add("Sesión iniciada correctamente", Severity.Success);
                
                // Notificar al AuthenticationStateProvider que el estado ha cambiado
                // Esto permite que Blazor reconozca inmediatamente que el usuario está autenticado
                if (AuthenticationStateProvider is CustomAuthStateProvider customProvider)
                {
                    customProvider.NotifyAuthenticationStateChanged();
                }
                
                // Esperar activamente a que el estado de autenticación se actualice
                // Verificar el AuthenticationStateProvider directamente en lugar de solo esperar tiempo
                bool authStateUpdated = false;
                for (int i = 0; i < 10; i++) // Máximo 1 segundo (10 x 100ms)
                {
                    await Task.Delay(100);
                    var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
                    if (authState.User.Identity?.IsAuthenticated == true)
                    {
                        authStateUpdated = true;
                        break;
                    }
                }
                
                // También verificar que AuthService confirme el estado
                // Esto es importante porque AuthService tiene el estado en memoria (_currentUser)
                if (!authStateUpdated)
                {
                    // Verificar directamente en AuthService (puede estar más actualizado que el provider)
                    for (int i = 0; i < 5; i++)
                    {
                        if (await AuthService.IsAuthenticatedAsync())
                        {
                            authStateUpdated = true;
                            break;
                        }
                        await Task.Delay(100);
                    }
                }
                
                // Navegar a Home solo si el estado se actualizó correctamente
                if (authStateUpdated)
                {
                    Navigation.NavigateTo("/Home");
                }
                else
                {
                    // Si después de todos los reintentos no se actualizó, mostrar error
                    Snackbar.Add("Error al actualizar el estado de autenticación. Por favor, intenta nuevamente.", Severity.Error);
                }
            }
            else
            {
                Snackbar.Add("El usuario o la contraseña no coinciden", Severity.Error);
            }
        }
        catch (UnauthorizedAccessException)
        {
            Snackbar.Add("El usuario o la contraseña no coinciden", Severity.Error);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al iniciar sesión: {ex.Message}", Severity.Error);
            // Log del error completo para debugging
            Console.WriteLine($"Login error: {ex}");
        }
        finally
        {
            _isLoading = false;
        }
    }
}

