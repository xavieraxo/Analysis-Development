@page "/login"
@inject IAuthService AuthService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject AuthenticationStateProvider AuthenticationStateProvider

<MudContainer MaxWidth="MaxWidth.Small" Class="mt-16">
    <MudPaper Elevation="3" Class="pa-8">
        <MudText Typo="Typo.h4" Align="Align.Center" GutterBottom="true">
            @if (_showSuperAdminHash)
            {
                <text>SuperAdministrador</text>
            }
            else
            {
                <text>Iniciar Sesi√≥n</text>
            }
        </MudText>
        
        <!-- Enlace para mostrar/ocultar modo SuperAdministrador - MOVIDO FUERA DEL FORM -->
        <div class="mb-3" style="text-align: center;">
            <MudButton Variant="Variant.Text" 
                      Color="Color.Primary" 
                      Size="Size.Small"
                      OnClick="@(() => ToggleSuperAdminMode())" 
                      Style="text-transform: none;">
                @if (_showSuperAdminHash)
                {
                    <text>‚Üê Volver a login normal</text>
                }
                else
                {
                    <text>¬øEres SuperAdministrador?</text>
                }
            </MudButton>
        </div>
        
        <EditForm Model="@_loginModel" OnSubmit="HandleLogin">
            
            <!-- Campo de Email - Oculto si se muestra el hash de SuperAdmin -->
            @if (!_showSuperAdminHash)
            {
                <MudTextField @bind-Value="_loginModel.Email" 
                             @bind-Value:after="OnEmailChanged"
                             Label="Email" 
                             Variant="Variant.Outlined" 
                             FullWidth="true" 
                             Class="mt-4"
                             Required="true" />
            }
            
            <!-- Campo de Hash de SuperAdministrador - Oculto por defecto -->
            @if (_showSuperAdminHash)
            {
                <MudTextField @bind-Value="_superAdminHash" 
                             Label="Hash de SuperAdministrador" 
                             Variant="Variant.Outlined" 
                             FullWidth="true" 
                             Class="mt-4"
                             Required="true"
                             HelperText="Ingrese el hash de acceso de SuperAdministrador" />
            }
            
            <!-- Campo de Contrase√±a - Oculto si se muestra el hash de SuperAdmin -->
            @if (!_showSuperAdminHash)
            {
                <MudTextField @bind-Value="_loginModel.Password" 
                             Label="Contrase√±a" 
                             Variant="Variant.Outlined" 
                             InputType="InputType.Password" 
                             FullWidth="true" 
                             Class="mt-4" />
            }
            
            <MudButton ButtonType="ButtonType.Submit" 
                      Variant="Variant.Filled" 
                      Color="Color.Primary" 
                      FullWidth="true" 
                      Class="mt-4"
                      Disabled="@_isLoading">
                @if (_isLoading)
                {
                    <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                    <MudText Class="ms-2">Iniciando sesi√≥n...</MudText>
                }
                else
                {
                    <MudText>Iniciar Sesi√≥n</MudText>
                }
            </MudButton>
        </EditForm>
        
        <MudDivider Class="my-4" />
        
        <MudText Align="Align.Center">
            <MudLink Href="/register">¬øNo tienes cuenta? Reg√≠strate</MudLink>
        </MudText>
    </MudPaper>
</MudContainer>

@code {
    private LoginRequest _loginModel = new();
    private bool _isLoading = false;
    private bool _showSuperAdminHash = false;
    private string _superAdminHash = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        // Si el usuario ya est√° autenticado, redirigir a Home
        if (await AuthService.IsAuthenticatedAsync())
        {
            Navigation.NavigateTo("/Home");
        }
    }

    private void ToggleSuperAdminMode()
    {
        Console.WriteLine($"üîÑ Toggle SuperAdmin Mode - Antes: {_showSuperAdminHash}");
        _showSuperAdminHash = !_showSuperAdminHash;
        Console.WriteLine($"üîÑ Toggle SuperAdmin Mode - Despu√©s: {_showSuperAdminHash}");
        
        // Limpiar campos al cambiar de modo
        if (_showSuperAdminHash)
        {
            // Al mostrar el hash, limpiar email y contrase√±a
            _loginModel.Email = string.Empty;
            _loginModel.Password = string.Empty;
            Console.WriteLine("‚úÖ Modo SuperAdmin activado - Campos de login limpiados");
        }
        else
        {
            // Al volver a modo normal, limpiar el hash
            _superAdminHash = string.Empty;
            Console.WriteLine("‚úÖ Modo login normal activado - Hash limpiado");
        }
        
        StateHasChanged();
    }

    private void OnEmailChanged()
    {
        // Si no es un email v√°lido (probablemente es un hash), limpiar el campo de contrase√±a
        if (!IsValidEmail(_loginModel.Email))
        {
            _loginModel.Password = string.Empty;
            StateHasChanged();
        }
    }

    private static bool IsValidEmail(string email)
    {
        if (string.IsNullOrWhiteSpace(email))
            return true; // Si est√° vac√≠o, requerir contrase√±a por defecto

        try
        {
            var addr = new System.Net.Mail.MailAddress(email);
            return addr.Address == email;
        }
        catch
        {
            // Si no es un email v√°lido, probablemente es un hash
            return false;
        }
    }

    private async Task HandleLogin(EditContext context)
    {
        string email;
        string password;

        // Validaci√≥n seg√∫n el modo (SuperAdmin o normal)
        if (_showSuperAdminHash)
        {
            // Modo SuperAdministrador: solo validar hash
            if (string.IsNullOrWhiteSpace(_superAdminHash))
            {
                Snackbar.Add("El hash de SuperAdministrador es requerido", Severity.Warning);
                return;
            }

            email = _superAdminHash.Trim();
            password = string.Empty; // No se requiere contrase√±a para login con hash
            
            Console.WriteLine($"üîê Login SuperAdmin - Hash enviado: '{email}'");
            Console.WriteLine($"üîê Hash length: {email.Length}");
            Console.WriteLine($"üîê Hash esperado: 'A4F1C72E99B3842F7D1A5C0083F6D2B1'");
            Console.WriteLine($"üîê ¬øCoincide? {email.Equals("A4F1C72E99B3842F7D1A5C0083F6D2B1", StringComparison.OrdinalIgnoreCase)}");
        }
        else
        {
            // Modo normal: validar email y contrase√±a
            if (string.IsNullOrWhiteSpace(_loginModel.Email))
            {
                Snackbar.Add("El email es requerido", Severity.Warning);
                return;
            }

            var isValidEmail = IsValidEmail(_loginModel.Email);
            
            if (!isValidEmail)
            {
                Snackbar.Add("Por favor, ingrese un email v√°lido", Severity.Warning);
                return;
            }

            if (string.IsNullOrWhiteSpace(_loginModel.Password))
            {
                Snackbar.Add("La contrase√±a es requerida", Severity.Warning);
                return;
            }

            email = _loginModel.Email.Trim();
            password = _loginModel.Password;
            
            Console.WriteLine($"üîê Login Normal - Email: '{email}'");
        }

        _isLoading = true;
        try
        {
            Console.WriteLine($"üì° Enviando request de login...");
            var response = await AuthService.LoginAsync(email, password);
            Console.WriteLine($"üì° Response recibido: {(response != null ? "OK" : "NULL")}");
            
            if (response != null && !string.IsNullOrEmpty(response.Token))
            {
                var userName = response.User?.Name ?? "Usuario";
                Snackbar.Add($"¬°Bienvenido {userName}!", Severity.Success);
                
                // Notificar al AuthenticationStateProvider que el estado ha cambiado
                // Esto permite que Blazor reconozca inmediatamente que el usuario est√° autenticado
                if (AuthenticationStateProvider is CustomAuthStateProvider customProvider)
                {
                    customProvider.NotifyAuthenticationStateChanged();
                }
                
                // Esperar activamente a que el estado de autenticaci√≥n se actualice
                // Verificar el AuthenticationStateProvider directamente en lugar de solo esperar tiempo
                bool authStateUpdated = false;
                for (int i = 0; i < 10; i++) // M√°ximo 1 segundo (10 x 100ms)
                {
                    await Task.Delay(100);
                    var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
                    if (authState.User.Identity?.IsAuthenticated == true)
                    {
                        authStateUpdated = true;
                        break;
                    }
                }
                
                // Tambi√©n verificar que AuthService confirme el estado
                // Esto es importante porque AuthService tiene el estado en memoria (_currentUser)
                if (!authStateUpdated)
                {
                    // Verificar directamente en AuthService (puede estar m√°s actualizado que el provider)
                    for (int i = 0; i < 5; i++)
                    {
                        if (await AuthService.IsAuthenticatedAsync())
                        {
                            authStateUpdated = true;
                            break;
                        }
                        await Task.Delay(100);
                    }
                }
                
                // Navegar a Home solo si el estado se actualiz√≥ correctamente
                if (authStateUpdated)
                {
                    Navigation.NavigateTo("/Home");
                }
                else
                {
                    // Si despu√©s de todos los reintentos no se actualiz√≥, mostrar error
                    Snackbar.Add("Error al actualizar el estado de autenticaci√≥n. Por favor, intenta nuevamente.", Severity.Error);
                }
            }
            else
            {
                Snackbar.Add("‚ùå Credenciales inv√°lidas. Usuario o contrase√±a incorrectos.", Severity.Error);
            }
        }
        catch (UnauthorizedAccessException)
        {
            if (_showSuperAdminHash)
            {
                Snackbar.Add("‚ùå Hash de SuperAdministrador incorrecto", Severity.Error);
            }
            else
            {
                Snackbar.Add("‚ùå El usuario no existe o la contrase√±a es incorrecta", Severity.Error);
            }
        }
        catch (HttpRequestException httpEx)
        {
            Console.WriteLine($"Login HTTP error: {httpEx}");
            Snackbar.Add("‚ö†Ô∏è No se puede conectar con el servidor. Verifica que la API est√© ejecut√°ndose.", Severity.Warning);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"‚ùå Error al iniciar sesi√≥n: {ex.Message}", Severity.Error);
            // Log del error completo para debugging
            Console.WriteLine($"Login error: {ex}");
        }
        finally
        {
            _isLoading = false;
        }
    }
}

