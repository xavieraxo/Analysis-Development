@page "/profile"
@inject IAuthService AuthService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<PageTitle>Mi Perfil - Multi-Agent System</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-4">
    @if (!_isAuthenticated)
    {
        <MudAlert Severity="Severity.Warning">Debes iniciar sesión para ver tu perfil.</MudAlert>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="mt-4" OnClick="NavigateToLogin">
            Ir al Login
        </MudButton>
    }
    else
    {
        <MudPaper Elevation="2" Class="pa-6">
            <MudStack Spacing="4">
                <!-- Header con avatar y nombre -->
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                    <MudAvatar Color="Color.Primary" Size="Size.Large" Style="width: 80px; height: 80px; font-size: 2rem;">
                        @GetUserInitials()
                    </MudAvatar>
                    <MudStack Spacing="1">
                        <MudText Typo="Typo.h4">@_userName</MudText>
                        <MudChip T="string" Color="Color.Primary" Size="Size.Small" Variant="Variant.Filled">
                            @_userRole
                        </MudChip>
                    </MudStack>
                </MudStack>

                <MudDivider />

                <!-- Información del usuario -->
                <MudStack Spacing="3">
                    <MudText Typo="Typo.h6">Información de la Cuenta</MudText>
                    
                    <MudTextField @bind-Value="_userEmail" 
                                 Label="Email" 
                                 Variant="Variant.Outlined" 
                                 ReadOnly="true"
                                 Adornment="Adornment.Start"
                                 AdornmentIcon="@Icons.Material.Filled.Email" />
                    
                    <MudTextField @bind-Value="_userName" 
                                 Label="Nombre" 
                                 Variant="Variant.Outlined" 
                                 ReadOnly="true"
                                 Adornment="Adornment.Start"
                                 AdornmentIcon="@Icons.Material.Filled.Person" />
                    
                    <MudTextField @bind-Value="_userRole" 
                                 Label="Rol" 
                                 Variant="Variant.Outlined" 
                                 ReadOnly="true"
                                 Adornment="Adornment.Start"
                                 AdornmentIcon="@Icons.Material.Filled.AdminPanelSettings" />
                    
                    <MudTextField @bind-Value="_userId" 
                                 Label="ID de Usuario" 
                                 Variant="Variant.Outlined" 
                                 ReadOnly="true"
                                 Adornment="Adornment.Start"
                                 AdornmentIcon="@Icons.Material.Filled.Tag" />
                </MudStack>

                <MudDivider />

                <!-- Acciones -->
                <MudStack Spacing="2">
                    <MudText Typo="Typo.h6">Acciones</MudText>
                    
                    <MudButton Variant="Variant.Outlined" 
                              Color="Color.Primary" 
                              StartIcon="@Icons.Material.Filled.Lock"
                              OnClick="ShowChangePasswordDialog"
                              FullWidth="true">
                        Cambiar Contraseña
                    </MudButton>
                    
                    <MudButton Variant="Variant.Filled" 
                              Color="Color.Error" 
                              StartIcon="@Icons.Material.Filled.Logout"
                              OnClick="HandleLogout"
                              FullWidth="true">
                        Cerrar Sesión
                    </MudButton>
                </MudStack>
            </MudStack>
        </MudPaper>
    }
</MudContainer>

@code {
    private bool _isAuthenticated = false;
    private string _userName = string.Empty;
    private string _userEmail = string.Empty;
    private string _userRole = string.Empty;
    private string _userId = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadUserInfo();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await Task.Delay(200);
            await LoadUserInfo();
            StateHasChanged();
        }
    }

    private async Task LoadUserInfo()
    {
        try
        {
            _isAuthenticated = await AuthService.IsAuthenticatedAsync();
            
            if (!_isAuthenticated)
            {
                Navigation.NavigateTo("/login");
                return;
            }

            var user = AuthService.GetUser();
            if (user != null)
            {
                _userName = user.Name ?? "Usuario";
                _userEmail = user.Email ?? "Sin email";
                _userRole = GetRoleDisplayName(user.Role ?? "Final");
                _userId = user.Id.ToString();
            }
        }
        catch
        {
            _isAuthenticated = false;
            Navigation.NavigateTo("/login");
        }
    }

    private string GetRoleDisplayName(string role)
    {
        return role switch
        {
            "Admin" => "Administrador",
            "Final" => "Usuario Final",
            "Empresa" => "Usuario Empresa",
            "SuperUsuario" => "Super Usuario",
            _ => role
        };
    }

    private string GetUserInitials()
    {
        if (string.IsNullOrWhiteSpace(_userName))
            return "U";

        var parts = _userName.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
        {
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();
        }
        else if (parts.Length == 1 && parts[0].Length >= 2)
        {
            return parts[0].Substring(0, 2).ToUpper();
        }
        else if (parts.Length == 1 && parts[0].Length == 1)
        {
            return parts[0].ToUpper();
        }
        
        return "U";
    }

    private void NavigateToLogin()
    {
        Navigation.NavigateTo("/login");
    }

    private void ShowChangePasswordDialog()
    {
        Snackbar.Add("Funcionalidad de cambio de contraseña próximamente", Severity.Info);
        // TODO: Implementar diálogo de cambio de contraseña
    }

    private async Task HandleLogout()
    {
        try
        {
            await AuthService.LogoutAsync();
            Snackbar.Add("Sesión cerrada correctamente", Severity.Success);
            Navigation.NavigateTo("/login", forceLoad: true);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al cerrar sesión: {ex.Message}", Severity.Error);
        }
    }
}

