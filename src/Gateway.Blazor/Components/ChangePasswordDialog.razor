@inject ISnackbar Snackbar

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.Lock" Class="mr-2" />
            Cambiar Contraseña
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudStack Spacing="3">
            <MudAlert Severity="Severity.Info" Dense="true">
                La contraseña debe tener entre 8 y 32 caracteres, incluir mayúsculas, números y caracteres especiales (: ; _ - # @)
            </MudAlert>

            <MudTextField @bind-Value="_currentPassword" 
                         Label="Contraseña Actual" 
                         Variant="Variant.Outlined" 
                         InputType="@_currentPasswordInputType"
                         Required="true"
                         RequiredError="La contraseña actual es obligatoria"
                         @ref="_currentPasswordField"
                         Adornment="Adornment.End"
                         AdornmentIcon="@_currentPasswordIcon"
                         OnAdornmentClick="ToggleCurrentPasswordVisibility" />
            
            <MudTextField @bind-Value="_newPassword" 
                         Label="Nueva Contraseña" 
                         Variant="Variant.Outlined" 
                         InputType="@_newPasswordInputType"
                         Required="true"
                         RequiredError="La nueva contraseña es obligatoria"
                         @ref="_newPasswordField"
                         Adornment="Adornment.End"
                         AdornmentIcon="@_newPasswordIcon"
                         OnAdornmentClick="ToggleNewPasswordVisibility"
                         HelperText="Mínimo 8 caracteres, máximo 32. Incluir mayúsculas, números y caracteres especiales" />
            
            <MudTextField @bind-Value="_confirmPassword" 
                         Label="Confirmar Nueva Contraseña" 
                         Variant="Variant.Outlined" 
                         InputType="@_confirmPasswordInputType"
                         Required="true"
                         RequiredError="Debes confirmar la nueva contraseña"
                         @ref="_confirmPasswordField"
                         Adornment="Adornment.End"
                         AdornmentIcon="@_confirmPasswordIcon"
                         OnAdornmentClick="ToggleConfirmPasswordVisibility" />
            
            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <MudAlert Severity="Severity.Error" Dense="true">@_errorMessage</MudAlert>
            }
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Color="Color.Secondary" Variant="Variant.Text">Cancelar</MudButton>
        <MudButton OnClick="Submit" Color="Color.Primary" Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Check" Disabled="@_isProcessing">
            @if (_isProcessing)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                <span>Cambiando...</span>
            }
            else
            {
                <span>Cambiar Contraseña</span>
            }
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance? MudDialog { get; set; }

    private string _currentPassword = string.Empty;
    private string _newPassword = string.Empty;
    private string _confirmPassword = string.Empty;
    private string _errorMessage = string.Empty;
    private bool _isProcessing = false;

    private MudTextField<string>? _currentPasswordField;
    private MudTextField<string>? _newPasswordField;
    private MudTextField<string>? _confirmPasswordField;

    // Visibilidad de contraseñas
    private bool _showCurrentPassword = false;
    private bool _showNewPassword = false;
    private bool _showConfirmPassword = false;

    private InputType _currentPasswordInputType => _showCurrentPassword ? InputType.Text : InputType.Password;
    private InputType _newPasswordInputType => _showNewPassword ? InputType.Text : InputType.Password;
    private InputType _confirmPasswordInputType => _showConfirmPassword ? InputType.Text : InputType.Password;

    private string _currentPasswordIcon => _showCurrentPassword ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff;
    private string _newPasswordIcon => _showNewPassword ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff;
    private string _confirmPasswordIcon => _showConfirmPassword ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff;

    private void ToggleCurrentPasswordVisibility() => _showCurrentPassword = !_showCurrentPassword;
    private void ToggleNewPasswordVisibility() => _showNewPassword = !_showNewPassword;
    private void ToggleConfirmPasswordVisibility() => _showConfirmPassword = !_showConfirmPassword;

    private void Submit()
    {
        _errorMessage = string.Empty;
        
        // Validar contraseña actual
        if (string.IsNullOrWhiteSpace(_currentPassword))
        {
            _errorMessage = "La contraseña actual es obligatoria";
            Snackbar.Add(_errorMessage, Severity.Error);
            _currentPasswordField?.FocusAsync();
            return;
        }

        // Validar nueva contraseña
        if (string.IsNullOrWhiteSpace(_newPassword))
        {
            _errorMessage = "La nueva contraseña es obligatoria";
            Snackbar.Add(_errorMessage, Severity.Error);
            _newPasswordField?.FocusAsync();
            return;
        }

        // Validar longitud
        if (_newPassword.Length < 8)
        {
            _errorMessage = "La nueva contraseña debe tener al menos 8 caracteres";
            Snackbar.Add(_errorMessage, Severity.Error);
            _newPasswordField?.FocusAsync();
            return;
        }

        if (_newPassword.Length > 32)
        {
            _errorMessage = "La nueva contraseña no puede tener más de 32 caracteres";
            Snackbar.Add(_errorMessage, Severity.Error);
            _newPasswordField?.FocusAsync();
            return;
        }

        // Validar seguridad de contraseña
        if (!IsPasswordSecure(_newPassword))
        {
            _errorMessage = "La contraseña debe incluir mayúsculas, números y caracteres especiales (: ; _ - # @)";
            Snackbar.Add(_errorMessage, Severity.Error);
            _newPasswordField?.FocusAsync();
            return;
        }

        // Validar que no sea igual a la actual
        if (_currentPassword == _newPassword)
        {
            _errorMessage = "La nueva contraseña debe ser diferente a la actual";
            Snackbar.Add(_errorMessage, Severity.Error);
            _newPasswordField?.FocusAsync();
            return;
        }

        // Validar confirmación
        if (string.IsNullOrWhiteSpace(_confirmPassword))
        {
            _errorMessage = "Debes confirmar la nueva contraseña";
            Snackbar.Add(_errorMessage, Severity.Error);
            _confirmPasswordField?.FocusAsync();
            return;
        }

        if (_newPassword != _confirmPassword)
        {
            _errorMessage = "Las contraseñas no coinciden";
            Snackbar.Add(_errorMessage, Severity.Error);
            _confirmPasswordField?.FocusAsync();
            return;
        }

        // Validación exitosa
        var request = new ChangePasswordData
        { 
            CurrentPassword = _currentPassword, 
            NewPassword = _newPassword 
        };
        
        Console.WriteLine("[ChangePasswordDialog] Enviando solicitud de cambio de contraseña");
        MudDialog?.Close(DialogResult.Ok(request));
    }

    private void Cancel()
    {
        Console.WriteLine("[ChangePasswordDialog] Cancelado por usuario");
        MudDialog?.Cancel();
    }

    /// <summary>
    /// Valida que la contraseña sea segura:
    /// - Debe incluir al menos una letra mayúscula
    /// - Debe incluir al menos un número
    /// - Debe incluir al menos un carácter especial permitido: : ; _ - # @
    /// </summary>
    private static bool IsPasswordSecure(string password)
    {
        if (string.IsNullOrWhiteSpace(password))
            return false;

        bool hasUpperCase = password.Any(char.IsUpper);
        bool hasNumber = password.Any(char.IsDigit);
        
        // Caracteres especiales permitidos: : ; _ - # @
        char[] allowedSpecialChars = { ':', ';', '_', '-', '#', '@' };
        bool hasSpecialChar = password.Any(c => allowedSpecialChars.Contains(c));

        return hasUpperCase && hasNumber && hasSpecialChar;
    }

    public class ChangePasswordData
    {
        public string CurrentPassword { get; set; } = string.Empty;
        public string NewPassword { get; set; } = string.Empty;
    }
}

